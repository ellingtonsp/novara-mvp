#!/bin/bash

# ON-01 UAT Execution Script
# Follows cursor rules for proper feature validation

set -e

echo "ğŸ§ª ON-01 UAT EXECUTION SCRIPT"
echo "=============================="
echo "This script helps execute the ON-01 User Acceptance Testing"
echo ""

# Check if backend is running
echo "ğŸ” Checking backend status..."
if ! curl -s http://localhost:9002/api/health > /dev/null; then
    echo "âŒ Backend not running on port 9002"
    echo "Please start the backend first:"
    echo "  cd backend && NODE_ENV=development USE_LOCAL_DATABASE=true PORT=9002 node server.js"
    exit 1
fi
echo "âœ… Backend is running"

# Check if frontend is running
echo "ğŸ” Checking frontend status..."
if ! curl -s http://localhost:4200 > /dev/null; then
    echo "âŒ Frontend not running on port 4200"
    echo "Please start the frontend first:"
    echo "  cd frontend && npm run dev"
    exit 1
fi
echo "âœ… Frontend is running"

echo ""
echo "ğŸ“‹ UAT PREREQUISITES CHECKLIST"
echo "=============================="
echo "âœ… Backend running on port 9002"
echo "âœ… Frontend running on port 4200"
echo ""
echo "ğŸ“ MANUAL UAT STEPS REQUIRED:"
echo "=============================="
echo ""
echo "1. ğŸ“Š A/B Test Distribution Validation"
echo "   - Open browser in incognito mode"
echo "   - Navigate to http://localhost:4200"
echo "   - Note which path appears (Fast Lane vs Control)"
echo "   - Repeat 10 times, record distribution"
echo "   - Expected: 40-60% range for each path"
echo ""
echo "2. âš¡ Fast Lane User Journey"
echo "   - Set VITE_FORCE_ONBOARDING_PATH=test in frontend .env"
echo "   - Complete Fast Lane form (3 fields)"
echo "   - Complete Baseline Panel"
echo "   - Verify insights accessible"
echo ""
echo "3. ğŸ”„ Control Path User Journey"
echo "   - Set VITE_FORCE_ONBOARDING_PATH=control in frontend .env"
echo "   - Complete full onboarding form"
echo "   - Verify no baseline panel appears"
echo "   - Verify insights accessible immediately"
echo ""
echo "4. ğŸš« Insights Blocking Validation"
echo "   - Create incomplete test user (Fast Lane only, no baseline)"
echo "   - Try to access insights"
echo "   - Verify blocking message appears"
echo ""
echo "5. ğŸ—„ï¸ Database Validation"
echo "   - Check database records after testing:"
echo "   sqlite3 backend/data/novara-local.db \""
echo "   SELECT email, onboarding_path, baseline_completed, nickname"
echo "   FROM users"
echo "   WHERE email LIKE '%uat-%'"
echo "   ORDER BY created_at DESC"
echo "   LIMIT 5;\""
echo ""
echo "6. ğŸ“Š Analytics Tracking Validation"
echo "   - Open browser dev tools"
echo "   - Check Network tab for PostHog events"
echo "   - Verify onboarding_path_selected, onboarding_completed, baseline_completed"
echo ""
echo "ğŸ“„ Complete UAT guide available at:"
echo "docs/features/ON-01-onboarding-ab-experiment/UAT-testing-guide.md"
echo ""
echo "ğŸ¯ UAT SUCCESS CRITERIA:"
echo "========================"
echo "âœ… All 6 test scenarios pass"
echo "âœ… A/B distribution within 40-60% range"
echo "âœ… No console errors or data corruption"
echo "âœ… Performance acceptable (<2s response times)"
echo ""
echo "ğŸ“ After UAT completion:"
echo "========================"
echo "1. Document results in UAT guide"
echo "2. Update ON-01-IMPLEMENTATION-STATUS.md"
echo "3. Create staging deployment plan"
echo "4. Schedule production deployment"
echo ""
echo "ğŸš€ Ready to begin UAT testing!"
echo "Open http://localhost:4200 in your browser to start." 